<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order.Now</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        dark: '#1e293b',
                        darker: '#0f172a'
                    }
                }
            }
        }
    </script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        .animate-slide-up { animation: slideUp 0.4s ease-out; }
        .animate-scale-in { animation: scaleIn 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .animate-bounce-short { animation: bounceShort 0.5s ease-in-out; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        @keyframes bounceShort { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 dark:bg-darker dark:text-gray-100 transition-colors duration-200">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        // --- Firebase Imports ---
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAnalytics } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js';
        import { 
            getAuth, 
            signInWithPopup, 
            GoogleAuthProvider, 
            signOut, 
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword
        } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            updateDoc, 
            doc, 
            onSnapshot, 
            query, 
            orderBy, 
            serverTimestamp,
            runTransaction,
            deleteDoc,
            where
        } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // --- Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyD5fscbqUTJIo0EKfz5mdi5qScQ8kiOhRs",
            authDomain: "order-now-backend.firebaseapp.com",
            projectId: "order-now-backend",
            storageBucket: "order-now-backend.firebasestorage.app",
            messagingSenderId: "895688155864",
            appId: "1:895688155864:web:b623376af905cebb336dad",
            measurementId: "G-N1H3PFV1B5"
        };
        
        // --- API CONFIGURATION ---
        // Your specific Cloudflare Worker URL
        const CLOUDFLARE_WORKER_URL = "https://Order-worker.powerstudios.workers.dev"; 

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Icons ---
        const Icons = {
            Logo: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>,
            Store: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m2 7 4.41-4.41A2 2 0 0 1 7.83 2h8.34a2 2 0 0 1 1.42.59L22 7"/><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><path d="M15 22v-4a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v4"/><path d="M2 7h20"/><path d="M22 7v3a2 2 0 0 1-2 2v0a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 16 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 12 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 8 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 4 12v0a2 2 0 0 1-2-2V7"/></svg>,
            ShoppingCart: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/></svg>,
            LogOut: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>,
            Plus: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
            Trash2: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
            Search: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>,
            Mail: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>,
            XCircle: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>,
            LayoutDashboard: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>,
            Edit: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>,
            Check: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
            CheckCircle: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
            Moon: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>,
            Sun: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>,
            History: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 8v4l3 3m6-3a9 9 0 1 1-18 0 9 9 0 0 1 18 0z"/></svg>
        };

        const { useState, useEffect, useMemo } = React;

        const ADMIN_EMAIL = 'admin@eugeneevons.com';

        // --- Components ---

        const Button = ({ children, onClick, variant = 'primary', className = '', disabled = false, type = 'button' }) => {
            const baseStyle = "px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center justify-center gap-2";
            const variants = {
                primary: "bg-blue-600 text-white hover:bg-blue-700 disabled:bg-blue-300 shadow-sm dark:bg-blue-500 dark:hover:bg-blue-600",
                secondary: "bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 disabled:bg-gray-50 dark:bg-dark dark:border-gray-700 dark:text-gray-200 dark:hover:bg-gray-700",
                danger: "bg-red-50 text-red-600 hover:bg-red-100 dark:bg-red-900/20 dark:text-red-400",
                success: "bg-green-50 text-green-600 hover:bg-green-100 dark:bg-green-900/20 dark:text-green-400",
                outline: "border border-gray-300 text-gray-700 hover:bg-gray-50 dark:border-gray-600 dark:text-gray-300 dark:hover:bg-gray-800"
            };
            return (
                <button 
                    type={type}
                    onClick={onClick} 
                    disabled={disabled}
                    className={`${baseStyle} ${variants[variant]} ${className}`}
                >
                    {children}
                </button>
            );
        };

        const Input = ({ label, type = "text", value, onChange, placeholder, required = false }) => (
            <div className="mb-4">
                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{label}</label>
                <input
                    type={type}
                    value={value}
                    onChange={onChange}
                    placeholder={placeholder}
                    required={required}
                    className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all bg-white dark:bg-dark dark:text-white"
                />
            </div>
        );

        const Modal = ({ isOpen, onClose, children, size = "md" }) => {
            if (!isOpen) return null;
            const sizeClasses = { md: "max-w-md", lg: "max-w-lg" };
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fade-in">
                    <div className={`bg-white dark:bg-dark rounded-2xl shadow-2xl w-full ${sizeClasses[size]} p-8 animate-scale-in relative overflow-hidden dark:text-white`}>
                        {children}
                    </div>
                </div>
            );
        };

        const NotificationToast = ({ message, onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 5000);
                return () => clearTimeout(timer);
            }, [onClose]);

            return (
                <div className="fixed bottom-4 right-4 bg-white dark:bg-dark shadow-lg rounded-lg p-4 flex items-center gap-3 border-l-4 border-blue-500 animate-slide-up z-50 max-w-sm">
                    <div className="bg-blue-100 dark:bg-blue-900/30 p-2 rounded-full">
                        <Icons.Mail size={20} className="text-blue-600 dark:text-blue-400" />
                    </div>
                    <div>
                        <h4 className="font-semibold text-sm text-gray-900 dark:text-white">Notification</h4>
                        <p className="text-xs text-gray-600 dark:text-gray-400">{message}</p>
                    </div>
                    <button onClick={onClose} className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 ml-2">
                        <Icons.XCircle size={16} />
                    </button>
                </div>
            );
        };

        // --- Main App ---
        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [view, setView] = useState('store');
            const [products, setProducts] = useState([]);
            const [orders, setOrders] = useState([]);
            const [cart, setCart] = useState({}); 
            const [notifications, setNotifications] = useState([]);
            
            // Search & Filter State
            const [searchQuery, setSearchQuery] = useState('');
            const [selectedCategory, setSelectedCategory] = useState('All');
            const [darkMode, setDarkMode] = useState(false);

            // Popups
            const [cartPopup, setCartPopup] = useState(null); 
            const [checkoutSuccess, setCheckoutSuccess] = useState(null);

            // Login State
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [isRegistering, setIsRegistering] = useState(false);
            const [authError, setAuthError] = useState('');

            // Admin State
            const [productForm, setProductForm] = useState({ name: '', price: '', stock: '', image: '', category: '' });
            const [editingId, setEditingId] = useState(null); 
            const [isFormOpen, setIsFormOpen] = useState(false);

            const isAdmin = user?.email === ADMIN_EMAIL;

            // --- Effects ---
            
            useEffect(() => {
                if (darkMode) document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
            }, [darkMode]);

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
                    setUser(currentUser);
                    setLoading(false);
                    if (!currentUser) setView('login');
                    else setView('store');
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user) return;
                const unsubProducts = onSnapshot(query(collection(db, 'products')), (snapshot) => {
                    setProducts(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
                
                const unsubOrders = onSnapshot(collection(db, 'orders'), (snapshot) => {
                    let items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (!isAdmin) {
                        items = items.filter(o => o.userId === user.uid);
                    }
                    items.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                    setOrders(items);
                });

                return () => { unsubProducts(); unsubOrders(); };
            }, [user, isAdmin]);

            const categories = useMemo(() => {
                const cats = new Set(products.map(p => p.category || 'General'));
                return ['All', ...Array.from(cats)];
            }, [products]);

            const filteredProducts = useMemo(() => {
                return products.filter(p => {
                    const matchesSearch = p.name.toLowerCase().includes(searchQuery.toLowerCase());
                    const matchesCat = selectedCategory === 'All' || p.category === selectedCategory;
                    return matchesSearch && matchesCat;
                });
            }, [products, searchQuery, selectedCategory]);

            // --- Handlers ---

            const handleAuth = async (e) => {
                e.preventDefault();
                setAuthError('');
                try {
                    if (isRegistering) await createUserWithEmailAndPassword(auth, email, password);
                    else await signInWithEmailAndPassword(auth, email, password);
                } catch (err) { setAuthError(err.message); }
            };

            const handleGoogleLogin = async () => {
                try { await signInWithPopup(auth, new GoogleAuthProvider()); } 
                catch (err) { setAuthError("Google Sign-In failed."); }
            };

            // --- CLOUDFLARE WORKER EMAIL TRIGGER ---
            const triggerEmail = async (to, subject, htmlContent) => {
                // Show notification immediately
                setNotifications(p => [...p, { id: Date.now(), message: `Sending confirmation email to ${to}...` }]);

                try {
                    const res = await fetch(CLOUDFLARE_WORKER_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ to, subject, html: htmlContent })
                    });
                    
                    if (!res.ok) {
                        console.warn("Worker returned error:", await res.text());
                    } else {
                        console.log("Email request sent successfully to worker.");
                    }
                } catch (e) {
                    console.warn("Failed to reach Cloudflare Worker:", e);
                }
            };

            const addToCart = (product) => {
                if (product.stock <= (cart[product.id] || 0)) {
                    alert("No more stock available!");
                    return;
                }
                setCart(prev => ({ ...prev, [product.id]: (prev[product.id] || 0) + 1 }));
                setCartPopup(product.name); 
            };

            const updateCartQuantity = (id, delta) => {
                setCart(prev => {
                    const currentQty = prev[id] || 0;
                    const newQty = currentQty + delta;
                    if (newQty <= 0) {
                        const newCart = { ...prev };
                        delete newCart[id];
                        return newCart;
                    }
                    if (delta > 0) {
                        const product = products.find(p => p.id === id);
                        if (product && newQty > product.stock) return prev;
                    }
                    return { ...prev, [id]: newQty };
                });
            };

            const handleCheckout = async () => {
                if (!user) return;
                
                const orderItems = Object.entries(cart)
                    .map(([id, qty]) => {
                        const product = products.find(p => p.id === id);
                        return { productId: id, name: product?.name || 'Item', price: product?.price || 0, quantity: qty };
                    })
                    .filter(item => item.quantity > 0);
                
                if (orderItems.length === 0) return;

                const total = orderItems.reduce((acc, item) => acc + (item.price * item.quantity), 0);

                try {
                    await runTransaction(db, async (t) => {
                        for (const item of orderItems) {
                            const ref = doc(db, 'products', item.productId);
                            const snap = await t.get(ref);
                            if (!snap.exists()) throw "Product removed";
                            const newStock = snap.data().stock - item.quantity;
                            if (newStock < 0) throw `Insufficient stock: ${item.name}`;
                            t.update(ref, { stock: newStock });
                        }
                        const newOrderRef = doc(collection(db, 'orders'));
                        t.set(newOrderRef, {
                            userId: user.uid,
                            userEmail: user.email,
                            items: orderItems,
                            total: total,
                            status: 'pending_payment',
                            paymentMethod: 'counter',
                            createdAt: serverTimestamp()
                        });
                    });
                    
                    setCart({});
                    setView('store');
                    setCheckoutSuccess({ total }); 
                    
                    // Trigger Email via Worker
                    triggerEmail(user.email, "Order Confirmation - Order.Now", `
                        <h1>Order Confirmation</h1>
                        <p>Thank you for your order!</p>
                        <p>Total Due: <strong>$${total.toFixed(2)}</strong></p>
                        <p>Please proceed to the counter to complete your payment.</p>
                        <hr />
                        <p style="font-size: 12px; color: #666;">This is an automated message from Order.Now</p>
                    `);

                } catch (e) { alert("Checkout failed: " + e); }
            };

            // --- Admin Handlers ---
            const handleSaveProduct = async (e) => {
                e.preventDefault();
                if (!isAdmin) return;
                const data = {
                    name: productForm.name,
                    price: parseFloat(productForm.price),
                    stock: parseInt(productForm.stock),
                    image: productForm.image || 'https://placehold.co/400x300?text=Product',
                    category: productForm.category || 'General',
                };
                try {
                    if (editingId) await updateDoc(doc(db, 'products', editingId), data);
                    else await addDoc(collection(db, 'products'), { ...data, createdAt: serverTimestamp() });
                    closeForm();
                } catch (error) { console.error("Error saving:", error); }
            };

            const handleEditClick = (product) => {
                setProductForm({ name: product.name, price: product.price, stock: product.stock, image: product.image, category: product.category });
                setEditingId(product.id);
                setIsFormOpen(true);
            };

            const closeForm = () => {
                setProductForm({ name: '', price: '', stock: '', image: '', category: '' });
                setEditingId(null);
                setIsFormOpen(false);
            };

            const handleStatusChange = async (orderId, newStatus, email) => {
                if (!isAdmin) return;
                await updateDoc(doc(db, 'orders', orderId), { status: newStatus });
                
                let message = "";
                if (newStatus === 'paid') message = "Thank you for your payment! Your order is being processed.";
                else if (newStatus === 'refunded') message = "A refund has been processed for your order.";
                else message = `Your order status has been updated to: ${newStatus}`;

                triggerEmail(email, `Order Update: ${newStatus.toUpperCase()}`, `
                    <h2>Order Update</h2>
                    <p>${message}</p>
                    <p>Status: <strong>${newStatus.toUpperCase()}</strong></p>
                `);
            };

            const handleDeleteProduct = async (id) => {
                if (confirm('Delete this product?')) await deleteDoc(doc(db, 'products', id));
            };

            // --- Render ---

            if (loading) return <div className="min-h-screen flex items-center justify-center bg-gray-50 dark:bg-darker"><div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div></div>;

            if (view === 'login') return (
                <div className="min-h-screen flex items-center justify-center p-4 bg-gray-50 dark:bg-darker">
                    <div className="bg-white dark:bg-dark p-8 rounded-2xl shadow-xl w-full max-w-md">
                        <div className="text-center mb-8">
                            <div className="bg-blue-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4"><Icons.Logo className="text-white w-8 h-8" /></div>
                            <h1 className="text-2xl font-bold dark:text-white">Order.Now</h1>
                            <p className="text-gray-500 dark:text-gray-400">Welcome back!</p>
                        </div>
                        <form onSubmit={handleAuth} className="space-y-4">
                            <Input label="Email" type="email" value={email} onChange={e=>setEmail(e.target.value)} required />
                            <Input label="Password" type="password" value={password} onChange={e=>setPassword(e.target.value)} required />
                            {authError && <div className="text-red-500 text-sm">{authError}</div>}
                            <Button type="submit" className="w-full">{isRegistering ? 'Sign Up' : 'Sign In'}</Button>
                        </form>
                        <div className="mt-4"><Button onClick={handleGoogleLogin} variant="outline" className="w-full">Google Sign In</Button></div>
                        <p className="mt-6 text-center text-sm text-blue-600 dark:text-blue-400 cursor-pointer" onClick={()=>setIsRegistering(!isRegistering)}>{isRegistering ? 'Switch to Sign In' : 'Create Account'}</p>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen flex flex-col font-sans transition-colors duration-200">
                    <nav className="bg-white dark:bg-dark shadow-sm sticky top-0 z-40 border-b dark:border-gray-800">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex justify-between items-center">
                            <div className="flex items-center gap-2 sm:gap-4">
                                <div className="flex items-center gap-2 text-blue-600 dark:text-blue-400 cursor-pointer" onClick={()=>setView('store')}>
                                    <Icons.Logo />
                                    <span className="font-bold text-xl hidden sm:block text-gray-900 dark:text-white">Order.Now</span>
                                </div>
                                <div className="flex bg-gray-100 dark:bg-gray-800 rounded-lg p-1 ml-2 sm:ml-4">
                                    <button onClick={()=>setView('store')} className={`px-3 py-1.5 rounded-md text-sm font-medium transition-all ${view==='store'?'bg-white dark:bg-gray-700 shadow dark:text-white':'text-gray-500 dark:text-gray-400'}`}>Store</button>
                                    {!isAdmin && (
                                        <button onClick={()=>setView('history')} className={`px-3 py-1.5 rounded-md text-sm font-medium transition-all ${view==='history'?'bg-white dark:bg-gray-700 shadow dark:text-white':'text-gray-500 dark:text-gray-400'}`}>
                                            My Orders
                                        </button>
                                    )}
                                    {isAdmin && <button onClick={()=>setView('admin')} className={`px-3 py-1.5 rounded-md text-sm font-medium transition-all ${view==='admin'?'bg-white dark:bg-gray-700 shadow dark:text-white':'text-gray-500 dark:text-gray-400'}`}>Admin</button>}
                                </div>
                            </div>
                            <div className="flex items-center gap-3">
                                <button onClick={()=>setDarkMode(!darkMode)} className="p-2 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full dark:text-gray-400">
                                    {darkMode ? <Icons.Sun size={20}/> : <Icons.Moon size={20}/>}
                                </button>
                                <button onClick={()=>setView('cart')} className="relative p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full text-gray-600 dark:text-gray-300">
                                    <Icons.ShoppingCart size={24} />
                                    {Object.keys(cart).length > 0 && <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold w-5 h-5 rounded-full flex items-center justify-center">{Object.values(cart).reduce((a,b)=>a+b,0)}</span>}
                                </button>
                                <button onClick={()=>signOut(auth)} className="p-2 hover:text-red-600 dark:hover:text-red-400 text-gray-400"><Icons.LogOut size={20} /></button>
                            </div>
                        </div>
                    </nav>

                    <main className="flex-1 max-w-7xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        {/* STORE */}
                        {view === 'store' && (
                            <div className="animate-fade-in space-y-6">
                                {/* Search & Filters */}
                                <div className="flex flex-col md:flex-row gap-4 justify-between items-center sticky top-20 z-30 bg-gray-50/90 dark:bg-darker/90 backdrop-blur-sm py-2">
                                    <div className="relative w-full md:w-64">
                                        <Icons.Search className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" size={18} />
                                        <input 
                                            type="text" 
                                            placeholder="Search items..." 
                                            value={searchQuery}
                                            onChange={e => setSearchQuery(e.target.value)}
                                            className="w-full pl-10 pr-4 py-2 rounded-full border border-gray-200 dark:border-gray-700 bg-white dark:bg-dark focus:ring-2 focus:ring-blue-500 outline-none dark:text-white shadow-sm"
                                        />
                                    </div>
                                    <div className="flex gap-2 overflow-x-auto w-full md:w-auto pb-2 md:pb-0 no-scrollbar">
                                        {categories.map(cat => (
                                            <button 
                                                key={cat}
                                                onClick={() => setSelectedCategory(cat)}
                                                className={`px-4 py-1.5 rounded-full text-sm font-medium whitespace-nowrap transition-all ${
                                                    selectedCategory === cat 
                                                    ? 'bg-blue-600 text-white shadow-md' 
                                                    : 'bg-white dark:bg-dark border border-gray-200 dark:border-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-800'
                                                }`}
                                            >
                                                {cat}
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                {/* Products Grid */}
                                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                                    {filteredProducts.map(product => (
                                        <div key={product.id} className="bg-white dark:bg-dark rounded-xl shadow-sm hover:shadow-md transition-all overflow-hidden border border-gray-100 dark:border-gray-800 flex flex-col group">
                                            <div className="h-48 relative overflow-hidden">
                                                <img src={product.image} className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105" onError={(e)=>e.target.src='https://placehold.co/400x300'} />
                                                {product.stock <= 0 && <div className="absolute inset-0 bg-black/60 flex items-center justify-center"><span className="text-white font-bold px-3 py-1 bg-red-600 rounded-full text-sm">Out of Stock</span></div>}
                                            </div>
                                            <div className="p-5 flex-1 flex flex-col">
                                                <div className="flex justify-between mb-2">
                                                    <div><h3 className="font-semibold text-lg text-gray-900 dark:text-white">{product.name}</h3><p className="text-xs text-gray-500 dark:text-gray-400">{product.category}</p></div>
                                                    <span className="font-bold text-blue-600 dark:text-blue-400 text-lg">${product.price}</span>
                                                </div>
                                                <div className="mt-auto pt-4 flex justify-between items-center border-t border-gray-100 dark:border-gray-700">
                                                    <span className={`text-xs ${product.stock<5?'text-red-500 font-bold':'text-gray-500 dark:text-gray-400'}`}>{product.stock} in stock</span>
                                                    <Button onClick={()=>addToCart(product)} disabled={product.stock<=0} variant="primary" className="!py-1.5 !px-3 !text-xs"><Icons.Plus size={14}/> Add</Button>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                    {filteredProducts.length === 0 && <div className="col-span-full text-center py-20 text-gray-500 dark:text-gray-400">No items found matching your search.</div>}
                                </div>
                            </div>
                        )}

                        {/* CART */}
                        {view === 'cart' && (
                            <div className="max-w-2xl mx-auto animate-fade-in">
                                <h2 className="text-2xl font-bold mb-6 dark:text-white">Shopping Cart</h2>
                                {Object.keys(cart).length === 0 ? <div className="text-center py-10 text-gray-500 dark:text-gray-400">Cart is empty</div> : (
                                    <div className="bg-white dark:bg-dark rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden">
                                        {Object.entries(cart).map(([id, qty]) => {
                                            const p = products.find(x => x.id === id);
                                            return p ? (
                                                <div key={id} className="p-4 flex items-center gap-4 border-b border-gray-100 dark:border-gray-700 last:border-0">
                                                    <img src={p.image} className="w-16 h-16 rounded-lg object-cover bg-gray-100"/>
                                                    <div className="flex-1"><h4 className="font-medium text-gray-900 dark:text-white">{p.name}</h4><p className="text-sm text-gray-500 dark:text-gray-400">${p.price}</p></div>
                                                    <div className="flex items-center gap-3">
                                                        <button onClick={()=>updateCartQuantity(id, -1)} className="w-8 h-8 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center dark:text-white">-</button>
                                                        <span className="w-6 text-center text-sm font-medium dark:text-white">{qty}</span>
                                                        <button onClick={()=>updateCartQuantity(id, 1)} className="w-8 h-8 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center dark:text-white">+</button>
                                                    </div>
                                                    <div className="text-right w-20 font-bold text-gray-900 dark:text-white">${(p.price*qty).toFixed(2)}</div>
                                                </div>
                                            ) : null;
                                        })}
                                        <div className="bg-gray-50 dark:bg-gray-800 p-6 flex justify-between items-center">
                                            <div><p className="text-gray-500 dark:text-gray-400 text-sm">Total</p><p className="text-3xl font-bold text-gray-900 dark:text-white">${Object.entries(cart).reduce((acc,[id,q])=>{const p=products.find(x=>x.id===id);return acc+(p?p.price*q:0)},0).toFixed(2)}</p></div>
                                            <Button onClick={handleCheckout} className="px-8">Checkout</Button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* ORDER HISTORY (CUSTOMER) */}
                        {view === 'history' && !isAdmin && (
                            <div className="max-w-3xl mx-auto animate-fade-in">
                                <h2 className="text-2xl font-bold mb-6 dark:text-white flex items-center gap-2"><Icons.History /> My Orders</h2>
                                <div className="space-y-4">
                                    {orders.map(order => (
                                        <div key={order.id} className="bg-white dark:bg-dark p-6 rounded-xl border border-gray-100 dark:border-gray-700 shadow-sm">
                                            <div className="flex justify-between items-start mb-4">
                                                <div>
                                                    <div className="flex items-center gap-3 mb-1">
                                                        <span className="font-bold text-gray-900 dark:text-white">Order #{order.id.slice(0,5)}</span>
                                                        <span className={`px-3 py-1 rounded-full text-xs font-bold ${
                                                            order.status==='paid'||order.status==='received' ? 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400' :
                                                            order.status==='refunded' ? 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400' :
                                                            'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400'
                                                        }`}>
                                                            {order.status.replace('_', ' ').toUpperCase()}
                                                        </span>
                                                    </div>
                                                    <p className="text-sm text-gray-500 dark:text-gray-400">{new Date(order.createdAt?.seconds * 1000).toLocaleDateString()}</p>
                                                </div>
                                                <p className="text-xl font-bold text-gray-900 dark:text-white">${order.total}</p>
                                            </div>
                                            <div className="border-t border-gray-100 dark:border-gray-700 pt-4">
                                                {order.items.map(item => (
                                                    <div key={item.productId} className="flex justify-between text-sm py-1">
                                                        <span className="text-gray-600 dark:text-gray-300">{item.quantity}x {item.name}</span>
                                                        <span className="text-gray-900 dark:text-white font-medium">${item.price}</span>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    ))}
                                    {orders.length === 0 && <div className="text-center py-20 text-gray-500 dark:text-gray-400">You haven't placed any orders yet.</div>}
                                </div>
                            </div>
                        )}

                        {/* ADMIN */}
                        {view === 'admin' && isAdmin && (
                            <div className="space-y-8 animate-fade-in">
                                <div className="bg-white dark:bg-dark p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700">
                                    <div className="flex justify-between items-center mb-6">
                                        <h2 className="text-xl font-bold flex items-center gap-2 dark:text-white"><Icons.LayoutDashboard /> Dashboard</h2>
                                        <Button onClick={() => { closeForm(); setIsFormOpen(!isFormOpen); }} variant="outline">
                                            {isFormOpen ? 'Cancel' : 'Add Product'}
                                        </Button>
                                    </div>

                                    {/* Edit/Add Form */}
                                    {isFormOpen && (
                                        <div className="bg-gray-50 dark:bg-gray-800 p-6 rounded-xl mb-8 border border-gray-200 dark:border-gray-700 animate-slide-up">
                                            <h3 className="font-bold text-gray-700 dark:text-gray-200 mb-4">{editingId ? 'Edit Product' : 'Add New Product'}</h3>
                                            <form onSubmit={handleSaveProduct} className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                <Input label="Name" value={productForm.name} onChange={e=>setProductForm({...productForm, name: e.target.value})} required />
                                                <Input label="Price" type="number" value={productForm.price} onChange={e=>setProductForm({...productForm, price: e.target.value})} required />
                                                <Input label="Stock" type="number" value={productForm.stock} onChange={e=>setProductForm({...productForm, stock: e.target.value})} required />
                                                <Input label="Category" value={productForm.category} onChange={e=>setProductForm({...productForm, category: e.target.value})} />
                                                <div className="md:col-span-2"><Input label="Image URL" value={productForm.image} onChange={e=>setProductForm({...productForm, image: e.target.value})} /></div>
                                                <div className="md:col-span-2 flex gap-3">
                                                    <Button type="submit" className="flex-1">{editingId ? 'Update Product' : 'Create Product'}</Button>
                                                </div>
                                            </form>
                                        </div>
                                    )}

                                    {/* Product Table */}
                                    <div className="overflow-x-auto mb-8">
                                        <table className="min-w-full text-sm">
                                            <thead className="bg-gray-50 dark:bg-gray-800 text-gray-500 dark:text-gray-400">
                                                <tr><th className="px-4 py-2 text-left">Product</th><th className="px-4 py-2">Stock</th><th className="px-4 py-2">Price</th><th className="px-4 py-2 text-right">Actions</th></tr>
                                            </thead>
                                            <tbody className="divide-y divide-gray-100 dark:divide-gray-700 text-gray-700 dark:text-gray-300">
                                                {products.map(p => (
                                                    <tr key={p.id} className="hover:bg-gray-50 dark:hover:bg-gray-800/50">
                                                        <td className="px-4 py-3 font-medium">{p.name}</td>
                                                        <td className="px-4 py-3 text-center">{p.stock}</td>
                                                        <td className="px-4 py-3 text-center">${p.price}</td>
                                                        <td className="px-4 py-3 text-right flex justify-end gap-2">
                                                            <button onClick={() => handleEditClick(p)} className="p-1 text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/30 rounded"><Icons.Edit size={18} /></button>
                                                            <button onClick={() => handleDeleteProduct(p.id)} className="p-1 text-red-600 hover:bg-red-50 dark:hover:bg-red-900/30 rounded"><Icons.Trash2 size={18} /></button>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    {/* Orders List */}
                                    <h3 className="font-bold text-gray-700 dark:text-gray-300 mb-4">Recent Orders</h3>
                                    <div className="space-y-4">
                                        {orders.map(order => (
                                            <div key={order.id} className="border dark:border-gray-700 p-4 rounded-lg flex flex-col md:flex-row justify-between gap-4">
                                                <div>
                                                    <div className="flex items-center gap-2">
                                                        <span className="font-bold text-sm dark:text-white">Order #{order.id.slice(0,5)}</span>
                                                        <span className={`px-2 py-0.5 rounded-full text-xs font-bold ${order.status==='paid'?'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400':'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400'}`}>{order.status}</span>
                                                    </div>
                                                    <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">{order.userEmail}</p>
                                                    <div className="text-xs text-gray-600 dark:text-gray-300 mt-2">
                                                        {order.items.map(i => <span key={i.productId} className="block">â€¢ {i.quantity}x {i.name}</span>)}
                                                    </div>
                                                </div>
                                                <div className="flex gap-2 items-start">
                                                    <Button variant="success" className="!py-1 !px-2 !text-xs" onClick={()=>handleStatusChange(order.id,'paid',order.userEmail)}>Paid</Button>
                                                    <Button variant="danger" className="!py-1 !px-2 !text-xs" onClick={()=>handleStatusChange(order.id,'refunded',order.userEmail)}>Refund</Button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}
                        
                        {view === 'admin' && !isAdmin && <div className="text-center py-20 text-red-500 font-bold">Access Denied</div>}
                    </main>

                    {/* ADD TO CART POPUP */}
                    <Modal isOpen={!!cartPopup} onClose={()=>setCartPopup(null)}>
                        <div className="text-center">
                            <div className="w-12 h-12 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center mx-auto mb-4 text-green-600 dark:text-green-400">
                                <Icons.Check size={24} />
                            </div>
                            <h3 className="text-lg font-bold text-gray-900 dark:text-white mb-2">Item Added to Cart</h3>
                            <p className="text-gray-500 dark:text-gray-400 mb-6">"{cartPopup}" has been added. Will that be all?</p>
                            <div className="flex gap-3 flex-col sm:flex-row">
                                <Button variant="secondary" onClick={()=>setCartPopup(null)} className="w-full">No, Continue</Button>
                                <Button onClick={()=>{setCartPopup(null); setView('cart');}} className="w-full">Yes, Checkout</Button>
                            </div>
                        </div>
                    </Modal>

                    {/* BIG SUCCESS POPUP */}
                    <Modal isOpen={!!checkoutSuccess} onClose={()=>setCheckoutSuccess(null)} size="lg">
                        <div className="text-center pt-4">
                            <div className="w-24 h-24 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center mx-auto mb-6 text-green-600 dark:text-green-400 animate-bounce-short">
                                <Icons.CheckCircle size={48} />
                            </div>
                            <h2 className="text-3xl font-extrabold text-gray-900 dark:text-white mb-2">Order Successful!</h2>
                            <p className="text-gray-500 dark:text-gray-400 text-lg mb-8">Your order has been placed successfully.</p>
                            
                            <div className="bg-gray-50 dark:bg-gray-800 rounded-xl p-6 mb-8 border border-dashed border-gray-300 dark:border-gray-600">
                                <p className="text-sm text-gray-500 dark:text-gray-400 uppercase font-semibold mb-2">Amount Due</p>
                                <p className="text-4xl font-bold text-blue-600 dark:text-blue-400">${checkoutSuccess?.total.toFixed(2)}</p>
                            </div>

                            <div className="bg-blue-50 dark:bg-blue-900/20 border-l-4 border-blue-500 p-4 mb-8 text-left">
                                <p className="font-bold text-blue-700 dark:text-blue-300">Next Step:</p>
                                <p className="text-blue-600 dark:text-blue-400 text-sm">Please proceed to the counter to make your payment.</p>
                            </div>

                            <Button onClick={()=>setCheckoutSuccess(null)} className="w-full !py-3 !text-lg !rounded-xl shadow-lg shadow-blue-200 dark:shadow-none">
                                Got it, thanks!
                            </Button>
                        </div>
                    </Modal>

                    {notifications.map(n => <NotificationToast key={n.id} message={n.message} onClose={()=>setNotifications(p=>p.filter(x=>x.id!==n.id))} />)}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


