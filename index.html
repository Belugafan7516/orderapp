<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order.Now Platform</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        dark: '#1e293b',
                        darker: '#0f172a'
                    }
                }
            }
        }
    </script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        .animate-slide-up { animation: slideUp 0.4s ease-out; }
        .animate-scale-in { animation: scaleIn 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .animate-pulse-short { animation: pulseShort 0.2s ease-in-out; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        @keyframes pulseShort { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 dark:bg-darker dark:text-gray-100 transition-colors duration-200">
    <!-- Root Container -->
    <div id="root">
        <div class="h-screen flex items-center justify-center bg-gray-50">
            <div class="text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                <p class="text-gray-500 font-medium">Initializing App...</p>
            </div>
        </div>
    </div>

    <!-- Error Catcher -->
    <script>
        window.onerror = function(msg, url, line, col, error) {
            document.getElementById('root').innerHTML = `
                <div style="padding: 2rem; text-align: center; color: #ef4444; font-family: sans-serif;">
                    <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem;">System Error</h2>
                    <p style="background: #fee2e2; padding: 1rem; border-radius: 0.5rem; display: inline-block;">${msg}</p>
                    <p style="margin-top: 1rem; color: #6b7280; font-size: 0.875rem;">Try refreshing the page.</p>
                </div>
            `;
            return false;
        };
    </script>

    <script type="text/babel" data-type="module">
        // Using Stable Firebase v10.13.1
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, updateDoc, setDoc, getDoc, doc, onSnapshot, query, orderBy, serverTimestamp, runTransaction, deleteDoc, where } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js';

        // --- Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyD5fscbqUTJIo0EKfz5mdi5qScQ8kiOhRs",
            authDomain: "order-now-backend.firebaseapp.com",
            projectId: "order-now-backend",
            storageBucket: "order-now-backend.firebasestorage.app",
            messagingSenderId: "895688155864",
            appId: "1:895688155864:web:b623376af905cebb336dad",
            measurementId: "G-N1H3PFV1B5"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- AI Configuration ---
        const apiKey = ""; // Injected environment key

        // --- Icons ---
        const Icons = {
            Logo: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>,
            Store: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m2 7 4.41-4.41A2 2 0 0 1 7.83 2h8.34a2 2 0 0 1 1.42.59L22 7"/><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><path d="M15 22v-4a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v4"/><path d="M2 7h20"/><path d="M22 7v3a2 2 0 0 1-2 2v0a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 16 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 12 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 8 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 4 12v0a2 2 0 0 1-2-2V7"/></svg>,
            ShoppingCart: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/></svg>,
            CreditCard: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></svg>,
            Cash: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="20" height="12" x="2" y="6" rx="2"/><circle cx="12" cy="12" r="2"/><path d="M6 12h.01M18 12h.01"/></svg>,
            ArrowLeft: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>,
            Plus: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
            Trash2: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
            Search: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>,
            XCircle: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>,
            LayoutDashboard: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>,
            Edit: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>,
            Check: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
            CheckCircle: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
            Moon: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>,
            Sun: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>,
            History: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 8v4l3 3m6-3a9 9 0 1 1-18 0 9 9 0 0 1 18 0z"/></svg>,
            Sparkles: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 5H5"/><path d="M19 15v4"/><path d="M21 17h-4"/></svg>,
            ExternalLink: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" x2="21" y1="14" y2="3"/></svg>
        };

        const { useState, useEffect, useMemo } = React;

        // --- Helpers ---
        const callGeminiAPI = async (prompt, menu) => {
            const systemPrompt = `You are a helpful restaurant concierge. You have the following menu items (JSON format):
            ${JSON.stringify(menu.map(p => ({ id: p.id, name: p.name, price: p.price, category: p.category })))}
            
            The user says: "${prompt}"
            
            Task: Recommend up to 3 items from the menu that match the user's request.
            Output JSON ONLY in this format:
            {
                "recommendedIds": ["id1", "id2"],
                "reasoning": "A short, friendly explanation of why these were chosen."
            }
            Do not include Markdown formatting like \`\`\`json. Just the raw JSON string.`;

            if(!apiKey) return { recommendedIds: [], reasoning: "AI Key missing." };

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: systemPrompt }] }] })
                });
                
                if(!response.ok) throw new Error("AI Busy");
                const data = await response.json();
                let text = data.candidates?.[0]?.content?.parts?.[0]?.text || "{}";
                text = text.replace(/```json/g, '').replace(/```/g, '').trim();
                return JSON.parse(text);
            } catch (e) {
                console.error("AI Error", e);
                return { recommendedIds: [], reasoning: "Sorry, I couldn't reach the chef right now!" };
            }
        };

        // --- Components ---

        const Button = ({ children, onClick, variant = 'primary', className = '', disabled = false, type = 'button' }) => {
            const baseStyle = "px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center justify-center gap-2";
            const variants = {
                primary: "bg-blue-600 text-white hover:bg-blue-700 disabled:bg-blue-300 shadow-sm dark:bg-blue-500 dark:hover:bg-blue-600",
                secondary: "bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 disabled:bg-gray-50 dark:bg-dark dark:border-gray-700 dark:text-gray-200 dark:hover:bg-gray-700",
                danger: "bg-red-50 text-red-600 hover:bg-red-100 dark:bg-red-900/20 dark:text-red-400",
                success: "bg-green-50 text-green-600 hover:bg-green-100 dark:bg-green-900/20 dark:text-green-400",
                outline: "border border-gray-300 text-gray-700 hover:bg-gray-50 dark:border-gray-600 dark:text-gray-300 dark:hover:bg-gray-800",
                ai: "bg-gradient-to-r from-purple-600 to-blue-600 text-white hover:shadow-lg shadow-md transform hover:scale-105 transition-all"
            };
            return <button type={type} onClick={onClick} disabled={disabled} className={`${baseStyle} ${variants[variant]} ${className}`}>{children}</button>;
        };

        const Input = ({ label, type = "text", value, onChange, placeholder, required = false }) => (
            <div className="mb-4">
                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{label}</label>
                <input type={type} value={value} onChange={onChange} placeholder={placeholder} required={required} className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all bg-white dark:bg-dark dark:text-white"/>
            </div>
        );

        const Modal = ({ isOpen, onClose, children, size = "md" }) => {
            if (!isOpen) return null;
            const sizeClasses = { md: "max-w-md", lg: "max-w-lg", xl: "max-w-xl" };
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fade-in">
                    <div className={`bg-white dark:bg-dark rounded-2xl shadow-2xl w-full ${sizeClasses[size]} p-8 animate-scale-in relative overflow-hidden dark:text-white max-h-[90vh] overflow-y-auto`}>{children}</div>
                </div>
            );
        };

        const TextArea = ({ label, value, onChange, placeholder, required = false }) => (
            <div className="mb-4">
                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{label}</label>
                <textarea value={value} onChange={onChange} placeholder={placeholder} required={required} rows="3" className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all bg-white dark:bg-dark dark:text-white resize-none"/>
            </div>
        );

        // --- Main App ---
        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [view, setView] = useState('lobby'); 
            
            // Platform Data
            const [allOrgs, setAllOrgs] = useState([]);
            const [currentOrg, setCurrentOrg] = useState(null);
            const [products, setProducts] = useState([]);
            const [orders, setOrders] = useState([]);
            const [cart, setCart] = useState({}); 
            
            // UI State
            const [darkMode, setDarkMode] = useState(false);
            const [createOrgPopup, setCreateOrgPopup] = useState(false);
            const [newOrgName, setNewOrgName] = useState('');
            const [checkoutSuccess, setCheckoutSuccess] = useState(null);
            const [errorPopup, setErrorPopup] = useState(null); 

            // AI State
            const [aiModalOpen, setAiModalOpen] = useState(false);
            const [aiQuery, setAiQuery] = useState('');
            const [aiLoading, setAiLoading] = useState(false);
            const [aiResponse, setAiResponse] = useState(null); 

            // Login State
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [isRegistering, setIsRegistering] = useState(false);

            // Admin State
            const [productForm, setProductForm] = useState({ name: '', price: '', stock: '', image: '', category: '' });
            const [editingId, setEditingId] = useState(null); 
            const [isFormOpen, setIsFormOpen] = useState(false);
            const [storeSettings, setStoreSettings] = useState({ announcement: '', checkoutPrompt: '', stripeLink: '' });
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);

            // User Checkout State
            const [userNote, setUserNote] = useState(''); 
            const [customFieldResponse, setCustomFieldResponse] = useState(''); 
            const [paymentMethod, setPaymentMethod] = useState('counter'); 
            const [isProcessingPayment, setIsProcessingPayment] = useState(false);

            const isOrgOwner = user && currentOrg && user.uid === currentOrg.ownerId;

            // --- Init ---
            useEffect(() => {
                if (darkMode) document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
            }, [darkMode]);

            // Authentication & URL Param Handler
            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {
                    setUser(currentUser);
                    
                    if (!currentUser) {
                        setLoading(false);
                        setView('login');
                    } else {
                        // Check URL for ?store=ID
                        const params = new URLSearchParams(window.location.search);
                        const storeIdParam = params.get('store');

                        if (storeIdParam) {
                            try {
                                const orgDoc = await getDoc(doc(db, 'organizations', storeIdParam));
                                if (orgDoc.exists()) {
                                    setCurrentOrg({ id: orgDoc.id, ...orgDoc.data() });
                                    setView('store');
                                } else {
                                    console.error("Store param invalid");
                                    setView('lobby');
                                }
                            } catch (e) {
                                console.error("Error loading store param", e);
                                setView('lobby');
                            }
                        } else {
                            setView('lobby');
                        }
                        setLoading(false);
                    }
                });
                return () => unsubscribe();
            }, []);

            // Load All Orgs (Lobby)
            useEffect(() => {
                if (!user) return;
                const unsub = onSnapshot(collection(db, 'organizations'), (snap) => {
                    setAllOrgs(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                });
                return () => unsub();
            }, [user]);

            // Load Store Data when currentOrg changes
            useEffect(() => {
                if (!user || !currentOrg) return;
                
                // Load Products
                const unsubProd = onSnapshot(collection(db, 'organizations', currentOrg.id, 'products'), (snap) => {
                    setProducts(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                });

                // Load Orders (All if owner, User's if not)
                const ordersRef = collection(db, 'organizations', currentOrg.id, 'orders');
                const unsubOrders = onSnapshot(ordersRef, (snap) => {
                    let items = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    if (!isOrgOwner) {
                        items = items.filter(o => o.userId === user.uid);
                    }
                    items.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                    setOrders(items);
                });

                // Load Settings - Use 'docSnap' variable name
                const unsubSettings = onSnapshot(doc(db, 'organizations', currentOrg.id, 'config', 'main'), (docSnap) => {
                    if (docSnap.exists()) setStoreSettings(docSnap.data());
                    else setStoreSettings({ announcement: '', checkoutPrompt: '', stripeLink: '' });
                });

                return () => { unsubProd(); unsubOrders(); unsubSettings(); };
            }, [currentOrg, user, isOrgOwner]);

            // --- Logic ---

            const handleCreateOrg = async (e) => {
                e.preventDefault();
                if (!newOrgName.trim()) return;
                try {
                    await addDoc(collection(db, 'organizations'), {
                        name: newOrgName,
                        ownerId: user.uid,
                        ownerEmail: user.email,
                        createdAt: serverTimestamp()
                    });
                    setCreateOrgPopup(false);
                    setNewOrgName('');
                } catch (e) { setErrorPopup(e.message); }
            };

            const enterStore = (org) => {
                setCurrentOrg(org);
                setCart({});
                setAiResponse(null); 
                setView('store');
                window.history.pushState({}, '', `?store=${org.id}`);
            };

            const leaveStore = () => {
                setView('lobby'); 
                setCurrentOrg(null);
                window.history.pushState({}, '', window.location.pathname);
            }

            // AI LOGIC
            const handleAskAI = async (e) => {
                e.preventDefault();
                if (!aiQuery.trim()) return;
                setAiLoading(true);
                setAiResponse(null);
                
                const result = await callGeminiAPI(aiQuery, products);
                
                setAiResponse(result);
                setAiLoading(false);
            };

            const addToCart = (product) => {
                setCart(prev => ({ ...prev, [product.id]: (prev[product.id] || 0) + 1 }));
            };

            const updateCartQuantity = (id, delta) => {
                setCart(prev => {
                    const current = prev[id] || 0;
                    const next = current + delta;
                    if (next <= 0) { const copy = {...prev}; delete copy[id]; return copy; }
                    const prod = products.find(p => p.id === id);
                    if (delta > 0 && prod && next > prod.stock) return prev;
                    return { ...prev, [id]: next };
                });
            };

            const handleCheckout = async () => {
                if (!user || !currentOrg) return;
                
                if (storeSettings.checkoutPrompt && !customFieldResponse.trim()) {
                    setErrorPopup(`Please fill in: "${storeSettings.checkoutPrompt}" to continue.`);
                    return;
                }

                if (paymentMethod === 'card' && !storeSettings.stripeLink) {
                    setErrorPopup("This store has not configured Stripe payments yet. Please select Cash.");
                    return;
                }

                const orderItems = Object.entries(cart).map(([id, qty]) => {
                    const p = products.find(prod => prod.id === id);
                    return { productId: id, name: p?.name, price: p?.price, quantity: qty };
                }).filter(i => i.quantity > 0);

                if(orderItems.length === 0) return;

                const total = orderItems.reduce((acc, i) => acc + (i.price * i.quantity), 0);

                if (paymentMethod === 'card') {
                    setIsProcessingPayment(true);
                }

                try {
                    await runTransaction(db, async (t) => {
                        // 1. Read Stocks
                        const pRefs = orderItems.map(i => doc(db, 'organizations', currentOrg.id, 'products', i.productId));
                        const pSnaps = [];
                        for(const ref of pRefs) pSnaps.push(await t.get(ref));

                        // 2. Validate
                        pSnaps.forEach((snap, idx) => {
                            if(!snap.exists()) throw new Error("Item removed");
                            const stock = snap.data().stock;
                            const qty = orderItems[idx].quantity;
                            if(stock < qty) throw new Error(`Insufficient stock for ${orderItems[idx].name}`);
                            t.update(pRefs[idx], { stock: stock - qty });
                        });

                        // 3. Create Order
                        const orderRef = doc(collection(db, 'organizations', currentOrg.id, 'orders'));
                        t.set(orderRef, {
                            userId: user.uid,
                            userEmail: user.email,
                            items: orderItems,
                            total,
                            status: 'pending_payment',
                            paymentMethod: paymentMethod,
                            note: userNote, 
                            customResponse: customFieldResponse, 
                            customPromptLabel: storeSettings.checkoutPrompt,
                            createdAt: serverTimestamp()
                        });
                    });

                    // Redirect for Stripe
                    if (paymentMethod === 'card' && storeSettings.stripeLink) {
                        window.open(storeSettings.stripeLink, '_blank');
                    }

                    setCart({});
                    setUserNote('');
                    setCustomFieldResponse('');
                    setView('store');
                    setCheckoutSuccess({ total, method: paymentMethod });
                    setIsProcessingPayment(false);
                } catch(e) {
                    setIsProcessingPayment(false);
                    setErrorPopup(e.message);
                }
            };

            // Admin Logic
            const saveProduct = async (e) => {
                e.preventDefault();
                if (!isOrgOwner) return;
                const d = { 
                    name: productForm.name, 
                    price: parseFloat(productForm.price), 
                    stock: parseInt(productForm.stock), 
                    image: productForm.image,
                    category: productForm.category
                };
                try {
                    const col = collection(db, 'organizations', currentOrg.id, 'products');
                    if (editingId) await updateDoc(doc(col, editingId), d);
                    else await addDoc(col, { ...d, createdAt: serverTimestamp() });
                    setIsFormOpen(false);
                    setProductForm({ name: '', price: '', stock: '', image: '', category: '' });
                    setEditingId(null);
                } catch (e) { setErrorPopup(e.message); }
            };

            const handleSaveSettings = async (e) => {
                e.preventDefault();
                if (!isOrgOwner) return;
                try {
                    // Save to a sub-collection 'config' document 'main'
                    await setDoc(doc(db, 'organizations', currentOrg.id, 'config', 'main'), storeSettings);
                    setIsSettingsOpen(false);
                } catch (e) { setErrorPopup("Failed to save settings: " + e.message); }
            };

            const handleDeleteProduct = async (id) => {
                if(confirm("Delete item?")) await deleteDoc(doc(db, 'organizations', currentOrg.id, 'products', id));
            };

            const handleStatus = async (oid, status) => {
                await updateDoc(doc(db, 'organizations', currentOrg.id, 'orders', oid), { status });
            };

            // --- Render ---
            if (loading) return null; // Initial loading handled by HTML

            // LOGIN
            if (view === 'login') return (
                <div className="h-screen flex items-center justify-center bg-gray-50 dark:bg-darker px-4">
                    <div className="bg-white dark:bg-dark p-8 rounded-2xl shadow-xl w-full max-w-md">
                        <div className="text-center mb-8">
                            <h1 className="text-3xl font-bold dark:text-white mb-2">Order.Now</h1>
                            <p className="text-gray-500 dark:text-gray-400">Platform Login</p>
                        </div>
                        <Button onClick={() => signInWithPopup(auth, new GoogleAuthProvider())} className="w-full mb-4">Google Sign In</Button>
                        <form onSubmit={(e) => { e.preventDefault(); isRegistering ? createUserWithEmailAndPassword(auth, email, password) : signInWithEmailAndPassword(auth, email, password) }} className="space-y-4">
                            <Input placeholder="Email" value={email} onChange={e=>setEmail(e.target.value)} />
                            <Input type="password" placeholder="Password" value={password} onChange={e=>setPassword(e.target.value)} />
                            <Button type="submit" variant="secondary" className="w-full">{isRegistering ? 'Register' : 'Login with Email'}</Button>
                        </form>
                        <p className="text-center mt-4 text-sm text-blue-500 cursor-pointer" onClick={()=>setIsRegistering(!isRegistering)}>{isRegistering ? 'Back to Login' : 'Create Account'}</p>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen flex flex-col font-sans transition-colors duration-200">
                    <nav className="bg-white dark:bg-dark shadow-sm sticky top-0 z-40 border-b dark:border-gray-800">
                        <div className="max-w-7xl mx-auto px-4 h-16 flex justify-between items-center">
                            <div className="flex items-center gap-3 cursor-pointer" onClick={leaveStore}>
                                <Icons.Logo className="text-blue-600" />
                                <span className="font-bold text-xl dark:text-white">Order.Now</span>
                                {currentOrg && <span className="text-gray-400 text-sm hidden sm:block">/ {currentOrg.name}</span>}
                            </div>
                            <div className="flex gap-2 items-center">
                                <Button onClick={() => setDarkMode(!darkMode)} variant="outline" className="!p-2"><Icons.Moon size={20}/></Button>
                                {currentOrg && (
                                    <Button onClick={() => setView('cart')} variant="outline" className="relative !p-2">
                                        <Icons.ShoppingCart size={20} />
                                        {Object.keys(cart).length > 0 && <span className="absolute -top-1 -right-1 bg-red-500 w-4 h-4 rounded-full text-[10px] text-white flex items-center justify-center">{Object.keys(cart).length}</span>}
                                    </Button>
                                )}
                                <Button onClick={() => signOut(auth)} variant="outline" className="!p-2"><Icons.LogOut size={20}/></Button>
                            </div>
                        </div>
                    </nav>

                    <main className="flex-1 max-w-7xl w-full mx-auto px-4 py-8">
                        {/* LOBBY VIEW */}
                        {view === 'lobby' && (
                            <div className="animate-fade-in">
                                <div className="flex justify-between items-center mb-8">
                                    <h2 className="text-2xl font-bold dark:text-white">Available Stores</h2>
                                    <Button onClick={() => setCreateOrgPopup(true)}><Icons.Plus size={18} /> Create Store</Button>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    {allOrgs.map(org => (
                                        <div key={org.id} onClick={() => enterStore(org)} className="bg-white dark:bg-dark p-6 rounded-xl shadow-sm hover:shadow-md cursor-pointer border border-gray-100 dark:border-gray-700 transition-all group">
                                            <div className="flex justify-between items-start mb-4">
                                                <div className="bg-blue-100 dark:bg-blue-900/30 p-3 rounded-lg text-blue-600 dark:text-blue-400 group-hover:scale-110 transition-transform">
                                                    <Icons.Store size={24} />
                                                </div>
                                                {org.ownerId === user.uid && <span className="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full font-bold">OWNER</span>}
                                            </div>
                                            <h3 className="text-xl font-bold dark:text-white mb-1">{org.name}</h3>
                                            <p className="text-sm text-gray-500 dark:text-gray-400">Tap to visit</p>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* STORE VIEW */}
                        {view === 'store' && currentOrg && (
                            <div className="animate-fade-in">
                                {storeSettings.announcement && (
                                    <div className="bg-blue-600 dark:bg-blue-800 text-white px-4 py-3 rounded-xl mb-6 shadow-md flex items-center">
                                        <span className="font-medium mr-2">ðŸ“¢ Notice:</span>
                                        <span>{storeSettings.announcement}</span>
                                    </div>
                                )}

                                <div className="flex flex-col sm:flex-row justify-between items-end mb-6 gap-4">
                                    <h2 className="text-2xl font-bold dark:text-white">{currentOrg.name}</h2>
                                    <div className="flex gap-2 w-full sm:w-auto">
                                        <Button onClick={() => setAiModalOpen(true)} variant="ai" className="w-full sm:w-auto"><Icons.Sparkles size={18} className="mr-1"/> AI Assistant</Button>
                                        {isOrgOwner && <Button onClick={() => setView('admin')} variant="secondary" className="w-full sm:w-auto"><Icons.LayoutDashboard size={18}/> Manage</Button>}
                                    </div>
                                </div>

                                {/* Filtered Products if AI is Active */}
                                {aiResponse && (
                                    <div className="bg-gradient-to-r from-purple-50 to-blue-50 dark:from-purple-900/20 dark:to-blue-900/20 p-4 rounded-xl mb-6 border border-purple-100 dark:border-purple-800">
                                        <div className="flex justify-between items-start mb-2">
                                            <h3 className="font-bold text-purple-800 dark:text-purple-300 flex items-center gap-2"><Icons.Sparkles size={16}/> AI Recommendation</h3>
                                            <button onClick={() => setAiResponse(null)} className="text-gray-400 hover:text-gray-600"><Icons.XCircle size={18}/></button>
                                        </div>
                                        <p className="text-sm text-gray-700 dark:text-gray-300 mb-0">{aiResponse.reasoning}</p>
                                    </div>
                                )}

                                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                                    {products.map(p => {
                                        // Highlight if recommended
                                        const isRecommended = aiResponse?.recommendedIds?.includes(p.id);
                                        // Hide if filtering is active (AI Mode) AND it's not recommended
                                        if (aiResponse && !isRecommended) return null;

                                        return (
                                            <div key={p.id} className={`bg-white dark:bg-dark border dark:border-gray-700 rounded-xl overflow-hidden shadow-sm flex flex-col transition-all ${isRecommended ? 'ring-2 ring-purple-500 transform scale-105' : ''}`}>
                                                <div className="h-40 bg-gray-100 dark:bg-gray-800 relative">
                                                    <img src={p.image || 'https://placehold.co/400'} className="w-full h-full object-cover"/>
                                                    {p.stock <= 0 && <div className="absolute inset-0 bg-black/50 flex items-center justify-center text-white font-bold">Out of Stock</div>}
                                                    {isRecommended && <div className="absolute top-2 right-2 bg-purple-600 text-white text-xs px-2 py-1 rounded-full font-bold flex items-center gap-1"><Icons.Sparkles size={10}/> AI Pick</div>}
                                                </div>
                                                <div className="p-4 flex-1 flex flex-col">
                                                    <div className="flex justify-between mb-2">
                                                        <h3 className="font-bold dark:text-white">{p.name}</h3>
                                                        <span className="text-blue-600 font-bold">${p.price}</span>
                                                    </div>
                                                    <p className="text-xs text-gray-500 mb-4">{p.category}</p>
                                                    <Button onClick={() => addToCart(p)} disabled={p.stock <= 0} className="mt-auto w-full !py-1 text-sm">Add</Button>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                                {aiResponse && products.filter(p => aiResponse.recommendedIds.includes(p.id)).length === 0 && (
                                    <div className="text-center py-10 text-gray-500">No specific matches found, but check out our full menu!</div>
                                )}
                            </div>
                        )}

                        {/* CART VIEW */}
                        {view === 'cart' && (
                            <div className="max-w-2xl mx-auto animate-fade-in">
                                <Button onClick={() => setView('store')} variant="secondary" className="mb-4"><Icons.ArrowLeft size={16}/> Back</Button>
                                <div className="bg-white dark:bg-dark p-6 rounded-xl shadow-sm border dark:border-gray-700">
                                    <h2 className="text-xl font-bold mb-4 dark:text-white">Checkout</h2>
                                    {Object.entries(cart).map(([id, qty]) => {
                                        const p = products.find(prod => prod.id === id);
                                        return (
                                            <div key={id} className="flex justify-between items-center py-3 border-b dark:border-gray-700">
                                                <div className="flex items-center gap-3">
                                                    <span className="font-bold text-gray-900 dark:text-white">{qty}x</span>
                                                    <span className="text-gray-700 dark:text-gray-300">{p?.name}</span>
                                                </div>
                                                <div className="flex items-center gap-4">
                                                    <span className="font-bold dark:text-white">${(p?.price * qty).toFixed(2)}</span>
                                                    <button onClick={() => updateCartQuantity(id, -1)} className="text-red-500 hover:text-red-700"><Icons.Trash2 size={18}/></button>
                                                </div>
                                            </div>
                                        );
                                    })}
                                    
                                    {/* USER INPUTS SECTION */}
                                    <div className="mt-6 space-y-4">
                                        <TextArea label="Message to Seller" placeholder="e.g. No ice, Allergic to peanuts..." value={userNote} onChange={e => setUserNote(e.target.value)} />
                                        {storeSettings.checkoutPrompt && (
                                            <Input label={`${storeSettings.checkoutPrompt} (Required)`} placeholder="Your answer here..." value={customFieldResponse} onChange={e => setCustomFieldResponse(e.target.value)} required />
                                        )}
                                    </div>

                                    {/* Payment Method Selection */}
                                    <div className="mt-8">
                                        <h3 className="font-semibold mb-3 dark:text-white">Payment Method</h3>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div onClick={() => setPaymentMethod('counter')} className={`cursor-pointer border rounded-xl p-4 flex flex-col items-center gap-2 transition-all ${paymentMethod === 'counter' ? 'border-blue-600 bg-blue-50 dark:bg-blue-900/20 text-blue-700' : 'dark:border-gray-600 dark:text-gray-400'}`}>
                                                <Icons.Cash size={24} />
                                                <span className="text-sm font-medium">Cash at Counter</span>
                                            </div>
                                            <div onClick={() => setPaymentMethod('card')} className={`cursor-pointer border rounded-xl p-4 flex flex-col items-center gap-2 transition-all ${paymentMethod === 'card' ? 'border-blue-600 bg-blue-50 dark:bg-blue-900/20 text-blue-700' : 'dark:border-gray-600 dark:text-gray-400'}`}>
                                                <Icons.CreditCard size={24} />
                                                <span className="text-sm font-medium">Card (Stripe)</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="mt-8 flex justify-between items-center pt-4 border-t dark:border-gray-700">
                                        <span className="text-gray-500">Total</span>
                                        <span className="text-3xl font-bold dark:text-white">${Object.entries(cart).reduce((acc,[id,q])=>{const p=products.find(x=>x.id===id);return acc+(p?p.price*q:0)},0).toFixed(2)}</span>
                                    </div>
                                    <Button onClick={handleCheckout} className="w-full mt-4" disabled={Object.keys(cart).length === 0 || isProcessingPayment}>
                                        {isProcessingPayment ? 'Redirecting to Stripe...' : `Pay $${Object.entries(cart).reduce((acc,[id,q])=>{const p=products.find(x=>x.id===id);return acc+(p?p.price*q:0)},0).toFixed(2)}`}
                                    </Button>
                                </div>
                            </div>
                        )}

                        {/* ADMIN VIEW */}
                        {view === 'admin' && isOrgOwner && (
                            <div className="animate-fade-in">
                                <div className="flex justify-between mb-6">
                                    <Button onClick={() => setView('store')} variant="secondary"><Icons.ArrowLeft size={16}/> Back to Store</Button>
                                    <div className="flex gap-2">
                                        <Button onClick={() => setIsSettingsOpen(true)} variant="secondary">Store Settings</Button>
                                        <Button onClick={() => { setIsFormOpen(true); setEditingId(null); setProductForm({ name: '', price: '', stock: '', image: '', category: '' }); }}>Add Item</Button>
                                    </div>
                                </div>
                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                    {/* Products */}
                                    <div className="bg-white dark:bg-dark p-6 rounded-xl shadow-sm border dark:border-gray-700">
                                        <h3 className="font-bold mb-4 dark:text-white">Inventory</h3>
                                        <div className="space-y-2">
                                            {products.map(p => (
                                                <div key={p.id} className="flex justify-between items-center p-3 hover:bg-gray-50 dark:hover:bg-gray-800 rounded">
                                                    <div>
                                                        <div className="font-medium dark:text-white">{p.name}</div>
                                                        <div className="text-xs text-gray-500">Stock: {p.stock} | ${p.price}</div>
                                                    </div>
                                                    <div className="flex gap-2">
                                                        <button onClick={() => { setEditingId(p.id); setProductForm(p); setIsFormOpen(true); }} className="text-blue-600"><Icons.Edit size={18}/></button>
                                                        <button onClick={() => handleDeleteProduct(p.id)} className="text-red-600"><Icons.Trash2 size={18}/></button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    {/* Orders */}
                                    <div className="bg-white dark:bg-dark p-6 rounded-xl shadow-sm border dark:border-gray-700">
                                        <h3 className="font-bold mb-4 dark:text-white">Orders</h3>
                                        <div className="space-y-4">
                                            {orders.map(o => (
                                                <div key={o.id} className="border dark:border-gray-700 p-3 rounded-lg">
                                                    <div className="flex justify-between mb-2">
                                                        <span className="font-bold text-sm dark:text-white">{o.userEmail}</span>
                                                        <span className={`text-xs px-2 py-0.5 rounded-full ${o.status === 'paid' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}`}>{o.status}</span>
                                                    </div>
                                                    
                                                    {/* Admin View of Notes */}
                                                    {(o.note || o.customResponse) && (
                                                        <div className="mb-2 bg-gray-50 dark:bg-gray-800 p-2 rounded text-xs border border-yellow-200 dark:border-yellow-900/50">
                                                            {o.note && <div className="mb-1"><strong className="text-yellow-600">Note:</strong> {o.note}</div>}
                                                            {o.customResponse && <div><strong className="text-blue-600">{o.customPromptLabel || 'Info'}:</strong> {o.customResponse}</div>}
                                                        </div>
                                                    )}

                                                    <ul className="text-sm text-gray-600 dark:text-gray-300 list-disc pl-4 mb-2">
                                                        {o.items.map((i, k) => <li key={k}>{i.quantity}x {i.name}</li>)}
                                                    </ul>
                                                    <div className="flex justify-end gap-2">
                                                        <Button variant="success" className="!py-1 !px-2 !text-xs" onClick={() => handleStatus(o.id, 'paid')}>Paid</Button>
                                                        <Button variant="danger" className="!py-1 !px-2 !text-xs" onClick={() => handleStatus(o.id, 'refunded')}>Refund</Button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>

                    {/* AI MODAL */}
                    <Modal isOpen={aiModalOpen} onClose={() => setAiModalOpen(false)}>
                        <div className="text-center mb-6">
                            <div className="bg-gradient-to-r from-purple-500 to-blue-500 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-4 text-white">
                                <Icons.Sparkles size={24} />
                            </div>
                            <h3 className="text-xl font-bold dark:text-white">AI Menu Concierge</h3>
                            <p className="text-gray-500 dark:text-gray-400 text-sm">Tell me what you're craving or your budget!</p>
                        </div>
                        <form onSubmit={handleAskAI} className="space-y-4">
                            <TextArea 
                                placeholder="e.g. I want a spicy dinner under $20, or something sweet for dessert." 
                                value={aiQuery} 
                                onChange={e => setAiQuery(e.target.value)}
                            />
                            <Button type="submit" variant="ai" className="w-full" disabled={aiLoading}>
                                {aiLoading ? 'Thinking...' : 'Get Recommendations'}
                            </Button>
                        </form>
                    </Modal>

                    {/* CREATE ORG MODAL */}
                    <Modal isOpen={createOrgPopup} onClose={() => setCreateOrgPopup(false)}>
                        <h3 className="text-xl font-bold mb-4 dark:text-white">Create New Store</h3>
                        <form onSubmit={handleCreateOrg}>
                            <Input label="Store Name" value={newOrgName} onChange={e => setNewOrgName(e.target.value)} required />
                            <Button type="submit" className="w-full">Create Store</Button>
                        </form>
                    </Modal>

                    {/* SETTINGS MODAL */}
                    <Modal isOpen={isSettingsOpen} onClose={() => setIsSettingsOpen(false)}>
                        <h3 className="font-bold text-gray-700 dark:text-gray-200 mb-4">Store Settings</h3>
                        <form onSubmit={handleSaveSettings} className="space-y-4">
                            <Input label="Announcement Banner" value={storeSettings.announcement} onChange={e => setStoreSettings({...storeSettings, announcement: e.target.value})} placeholder="e.g. Closing at 8 PM"/>
                            <Input label="Checkout Prompt" value={storeSettings.checkoutPrompt} onChange={e => setStoreSettings({...storeSettings, checkoutPrompt: e.target.value})} placeholder="e.g. Table Number"/>
                            
                            <div className="p-4 bg-gray-50 dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700">
                                <h4 className="font-bold mb-2 text-sm dark:text-white">Stripe Integration</h4>
                                <Input label="Stripe Payment Link" value={storeSettings.stripeLink} onChange={e => setStoreSettings({...storeSettings, stripeLink: e.target.value})} placeholder="https://buy.stripe.com/..."/>
                                <p className="text-xs text-gray-500">Paste your Stripe Payment Link here. This link will open when customers select 'Card' at checkout.</p>
                            </div>

                            <Button type="submit" className="w-full">Save</Button>
                        </form>
                    </Modal>

                    {/* PRODUCT FORM MODAL */}
                    <Modal isOpen={isFormOpen} onClose={() => setIsFormOpen(false)}>
                        <h3 className="text-xl font-bold mb-4 dark:text-white">{editingId ? 'Edit Product' : 'Add Product'}</h3>
                        <form onSubmit={saveProduct} className="space-y-4">
                            <Input label="Name" value={productForm.name} onChange={e => setProductForm({...productForm, name: e.target.value})} required />
                            <div className="flex gap-4">
                                <Input label="Price" type="number" value={productForm.price} onChange={e => setProductForm({...productForm, price: e.target.value})} required />
                                <Input label="Stock" type="number" value={productForm.stock} onChange={e => setProductForm({...productForm, stock: e.target.value})} required />
                            </div>
                            <Input label="Category" value={productForm.category} onChange={e => setProductForm({...productForm, category: e.target.value})} />
                            <Input label="Image URL" value={productForm.image} onChange={e => setProductForm({...productForm, image: e.target.value})} />
                            <Button type="submit" className="w-full">Save</Button>
                        </form>
                    </Modal>

                    {/* SUCCESS MODAL */}
                    <Modal isOpen={!!checkoutSuccess} onClose={() => setCheckoutSuccess(null)}>
                        <div className="text-center pt-4">
                            <div className="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 text-green-600 animate-pulse-short">
                                <Icons.CheckCircle size={40} />
                            </div>
                            <h2 className="text-2xl font-bold dark:text-white mb-2">Order Confirmed!</h2>
                            <p className="text-gray-500 mb-6">Total: ${checkoutSuccess?.total.toFixed(2)}</p>
                            
                            {checkoutSuccess?.method === 'card' && (
                                <div className="bg-blue-50 text-blue-700 p-4 rounded-xl text-sm mb-6 flex flex-col gap-2">
                                    <span className="font-bold flex items-center justify-center gap-2"><Icons.ExternalLink size={16}/> Payment Tab Opened</span>
                                    <span>Please complete your payment in the new tab. The store owner will verify your payment shortly.</span>
                                </div>
                            )}
                            
                            {checkoutSuccess?.method === 'counter' && (
                                <div className="bg-yellow-50 text-yellow-800 p-4 rounded-xl text-sm mb-6">
                                    Please pay at the counter.
                                </div>
                            )}

                            {/* Manual Pay Button for Failed/Pop-blocked Stripe */}
                            {checkoutSuccess?.method === 'card' && storeSettings.stripeLink && (
                                <Button onClick={() => window.open(storeSettings.stripeLink, '_blank')} variant="secondary" className="w-full mb-3">
                                    Re-open Payment Link
                                </Button>
                            )}

                            <Button onClick={() => setCheckoutSuccess(null)} className="w-full">Okay</Button>
                        </div>
                    </Modal>

                    {/* ERROR MODAL */}
                    <Modal isOpen={!!errorPopup} onClose={() => setErrorPopup(null)}>
                        <div className="text-center">
                            <Icons.XCircle size={40} className="text-red-500 mx-auto mb-4" />
                            <p className="text-gray-700 dark:text-gray-300 mb-6">{errorPopup}</p>
                            <Button onClick={() => setErrorPopup(null)} variant="secondary" className="w-full">Close</Button>
                        </div>
                    </Modal>

                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


